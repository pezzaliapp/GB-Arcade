<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0e1a12" />
  <link rel="manifest" href="manifest.webmanifest">
  <title>GB-Arcade — Free</title>

  <!-- Google Analytics 4 – GB-Arcade (SPA/PWA friendly) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-N48D6N3BXF"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }

    gtag('js', new Date());

    // PWA / “single page”
    gtag('config', 'G-N48D6N3BXF', {
      send_page_view: false,
      anonymize_ip: true
    });

    // helper globale eventi
    window.gaEvent = function(name, params){
      try { gtag('event', name, params || {}); } catch(e){}
    };

    // page_view iniziale
    window.addEventListener('load', () => {
      window.gaEvent('page_view', {
        page_title: document.title,
        page_location: location.href,
        page_path: location.pathname
      });
    });
  </script>

  <!-- Microsoft Clarity – GB-Arcade -->
  <script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "uvum6lp6ac");
  </script>

  <style>
    :root{
      --bg:#0a120d;
      --shell:#c9c7b8; --shell2:#bdbbad; --bezel:#1b2a21;
      --screen:#b9caa6; --screen2:#9fb18f; --ink:#142016;
      --btn:#6b6a63; --btn2:#5b5a54; --accent:#9a2240;
      --shadow: rgba(0,0,0,.28);
      --font: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      background: radial-gradient(1200px 800px at 50% -10%, #1b2a21, var(--bg));
      color:#eef3ea;
      font-family: var(--font);
      min-height:100svh;
      display:flex; align-items:center; justify-content:center;

      padding:
        calc(16px + env(safe-area-inset-top))
        calc(16px + env(safe-area-inset-right))
        calc(16px + env(safe-area-inset-bottom))
        calc(16px + env(safe-area-inset-left));

      overscroll-behavior: none;
      -webkit-overflow-scrolling: touch;

      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }

    .wrap{width:min(520px, 100%);}

    .handheld{
      background: linear-gradient(180deg, var(--shell), var(--shell2));
      border-radius: 34px;
      box-shadow: 0 18px 60px var(--shadow);
      padding: 18px;
      border: 1px solid rgba(255,255,255,.35);
      position: relative;
      overflow: hidden;
    }
    .handheld:before{
      content:""; position:absolute; inset:-40px -40px auto auto; width:140px; height:140px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.45), rgba(255,255,255,0));
      transform: rotate(18deg);
      pointer-events:none;
    }

    .toprow{
      display:flex; align-items:center; justify-content:space-between;
      padding: 2px 6px 10px;
      color:#2c3a31; font-weight:900; letter-spacing:.08em; font-size:12px;
    }
    .toprow small{opacity:.75}

    .pill{
      padding:4px 8px; border-radius:999px;
      border:1px solid rgba(0,0,0,.15);
      background: rgba(255,255,255,.28);
      color:#24332a; font-weight:900;
      white-space:nowrap;
    }

    .screen-bezel{
      background: linear-gradient(180deg, #22352b, var(--bezel));
      border-radius: 18px;
      padding: 14px;
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: inset 0 10px 20px rgba(0,0,0,.28);
    }
    .screen{
      background: linear-gradient(180deg, var(--screen), var(--screen2));
      border-radius: 10px;
      padding: 12px;
      border: 1px solid rgba(0,0,0,.25);
      position: relative;
    }

    canvas{
      width:100%;
      height:auto;
      display:block;
      image-rendering: pixelated;
      border-radius: 8px;
      background: rgba(0,0,0,.08);
      touch-action: none;
    }

    .hud{
      position:absolute; inset:10px 10px auto 10px;
      display:flex; justify-content:space-between; gap:10px;
      color: var(--ink);
      font-weight: 900; font-size: 12px;
      text-shadow: 0 1px 0 rgba(255,255,255,.18);
      pointer-events:none;
    }

    .hint{
      margin-top:10px;
      opacity:.90; font-size:12px; line-height:1.3;
      color:#1c2b22; background: rgba(255,255,255,.35);
      border: 1px solid rgba(0,0,0,.12);
      border-radius: 12px; padding: 8px 10px;
      white-space: normal;
    }

    .mobilebar{display:none; gap:10px; margin-top:10px;}
    .mkey{
      flex:1; padding:10px 12px; border-radius: 12px;
      border: 1px solid rgba(0,0,0,.18);
      background: rgba(255,255,255,.45);
      color:#16231c; font-family: var(--font); font-weight:900;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      cursor:pointer;
    }

    .controls{
      display:grid; grid-template-columns: 1fr 1fr;
      gap: 16px; margin-top: 16px; align-items:center;
    }

    .dpad{
      width: 160px; height: 160px; margin: 0 auto;
      position: relative;
      filter: drop-shadow(0 8px 12px rgba(0,0,0,.18));
      -webkit-user-select:none; user-select:none;
      touch-action: none;
    }
    .dpad button{
      position:absolute; border:0;
      background: linear-gradient(180deg, var(--btn), var(--btn2));
      color: rgba(255,255,255,.8);
      font-weight: 900; border-radius: 14px;
      box-shadow: inset 0 2px 0 rgba(255,255,255,.18), 0 8px 16px rgba(0,0,0,.22);
      -webkit-tap-highlight-color: transparent;
      cursor:pointer;
      touch-action: none;
    }
    .dpad .up{ left:50%; top:0; transform:translateX(-50%); width:58px; height:58px;}
    .dpad .down{ left:50%; bottom:0; transform:translateX(-50%); width:58px; height:58px;}
    .dpad .left{ left:0; top:50%; transform:translateY(-50%); width:58px; height:58px;}
    .dpad .right{ right:0; top:50%; transform:translateY(-50%); width:58px; height:58px;}
    .dpad .mid{
      left:50%; top:50%; transform:translate(-50%,-50%);
      width:62px; height:62px; border-radius: 18px;
      background: linear-gradient(180deg, #4f4e48, #3f3e39);
      pointer-events:none;
    }

    .ab{
      display:flex; justify-content:center; gap:14px; align-items:center;
      -webkit-user-select:none; user-select:none;
      touch-action: manipulation;
    }
    .ab .big{
      width:66px; height:66px; border-radius:999px; border:0;
      background: radial-gradient(circle at 30% 30%, #cf2a52, var(--accent));
      box-shadow: inset 0 2px 0 rgba(255,255,255,.18), 0 10px 18px rgba(0,0,0,.22);
      color: rgba(255,255,255,.92);
      font-weight: 900; font-size: 16px;
      -webkit-tap-highlight-color: transparent;
      cursor:pointer; touch-action: manipulation;
    }
    .ab .smallrow{ display:flex; gap:10px; margin-left:8px; }
    .ab .small{
      width:64px; height:30px; border-radius:999px; border:0;
      background: linear-gradient(180deg, #78776f, #64635c);
      box-shadow: inset 0 2px 0 rgba(255,255,255,.16), 0 8px 14px rgba(0,0,0,.18);
      color: rgba(255,255,255,.9);
      font-weight: 900; font-size: 12px;
      -webkit-tap-highlight-color: transparent;
      cursor:pointer; touch-action: manipulation;
    }

    .cartgrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .cart{
      border:1px solid rgba(0,0,0,.14);
      background: rgba(255,255,255,.28);
      border-radius: 14px;
      padding: 10px;
      color:#1c2b22;
      font-weight:900;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .cart small{display:block; opacity:.8; font-weight:900; margin-top:4px; font-size:11px;}
    .hidden{display:none;}

    @media (max-height: 760px) and (max-width: 430px){
      .handheld{ padding:12px; border-radius:28px; }
      .screen-bezel{ padding:10px; border-radius:16px; }
      .screen{ padding:10px; }
      .controls{ margin-top:12px; gap:10px; }
      .dpad{ width:132px; height:132px; }
      .dpad .up,.dpad .down,.dpad .left,.dpad .right{ width:48px; height:48px; border-radius:12px; }
      .dpad .mid{ width:54px; height:54px; border-radius:16px; }
      .ab .big{ width:58px; height:58px; font-size:15px; }
      .ab .smallrow{ display:none; }
      .mobilebar{ display:flex; }
      .hint{ font-size:11px; padding:7px 9px; }
      .cartgrid{ grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="handheld">

      <div class="toprow">
        <div>GB-ARCADE <small>FREE</small></div>
        <div style="display:flex;gap:8px;">
          <span class="pill" id="gamePill">MENU</span>
          <span class="pill" id="modePill">READY</span>
        </div>
      </div>

      <div class="screen-bezel">
        <div class="screen">
          <div class="hud">
            <div id="hudLeft">SCORE 000</div>
            <div id="hudRight">BEST 000</div>
          </div>

          <canvas id="c" width="256" height="256"></canvas>

          <div class="hint" id="msg">SEL = menu • START = play/pause • A = action • B = back/reset</div>

          <div class="mobilebar" aria-label="Comandi rapidi">
            <button class="mkey" id="mSel">SEL</button>
            <button class="mkey" id="mStart">START</button>
          </div>

          <div id="launcher" class="cartgrid" aria-label="Cartridges">
            <div class="cart" data-game="invaders">INVADERS<small>Space • shoot</small></div>
            <div class="cart" data-game="snake">SNAKE<small>Arcade • 20×20</small></div>
            <div class="cart" data-game="galattica">GALATTICA<small>Dodge • shield</small></div>
            <div class="cart" data-game="breakout">BREAKOUT<small>Paddle • bricks</small></div>
            <div class="cart" data-game="runner">RUNNER<small>Endless • jump</small></div>
            <div class="cart" data-game="tetris">TETRIS-LIKE<small>10×20 • lines</small></div>
          </div>
        </div>
      </div>

      <div class="controls">
        <div class="dpad" aria-label="D-Pad">
          <button type="button" class="up" data-dir="U">▲</button>
          <button type="button" class="down" data-dir="D">▼</button>
          <button type="button" class="left" data-dir="L">◀</button>
          <button type="button" class="right" data-dir="R">▶</button>
          <div class="mid"></div>
        </div>

        <div class="ab" aria-label="Pulsanti">
          <button type="button" class="big" id="btnA">A</button>
          <button type="button" class="big" id="btnB">B</button>
          <div class="smallrow">
            <button type="button" class="small" id="btnSel">SEL</button>
            <button type="button" class="small" id="btnStart">START</button>
          </div>
        </div>
      </div>

    </div>
  </div>

<script type="module">
  const APP_VER = '2026-01-03-arcade-9'; // bump to bust cache

  // SW
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', async () => {
      try { await navigator.serviceWorker.register('./sw.js'); }
      catch (e) { console.warn('SW register failed', e); }
    });
  }

  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');
  const msgEl = document.getElementById('msg');
  const hudL = document.getElementById('hudLeft');
  const hudR = document.getElementById('hudRight');
  const launcher = document.getElementById('launcher');
  const gamePill = document.getElementById('gamePill');
  const modePill = document.getElementById('modePill');

  // Input
  const input = {
    up:false, down:false, left:false, right:false,
    aPressed:false, bPressed:false, startPressed:false, selPressed:false
  };
  function clearPressed(){
    input.aPressed = input.bPressed = input.startPressed = input.selPressed = false;
  }

  function cssVar(name){
    return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
  }

  function track(eventName, params){
    // GA4
    if (window.gaEvent) window.gaEvent(eventName, params || {});
    // Clarity
    if (window.clarity) {
      try {
        // Clarity supports (eventName) or ('event', eventName)
        window.clarity('event', eventName);
      } catch(e){}
    }
  }

  function bindPress(elOrId, on){
    const el = (typeof elOrId === 'string') ? document.getElementById(elOrId) : elOrId;
    if (!el) return;
    let lockUntil = 0;
    const run = () => {
      const now = performance.now();
      if (now < lockUntil) return;
      lockUntil = now + 200;
      el.style.transform = 'translateY(1px)';
      setTimeout(()=> el.style.transform = '', 80);
      on();
    };
    el.addEventListener('pointerup', (e)=>{ e.preventDefault(); run(); });
    el.addEventListener('click', (e)=>{ e.preventDefault(); run(); });
    el.addEventListener('touchend', (e)=>{ e.preventDefault(); run(); }, {passive:false});
  }

  // D-PAD HOLD (press = move, release = stop)
  function clearDirs(){
    input.up = input.down = input.left = input.right = false;
  }
  function pressDir(d){
    clearDirs();
    if (d==='U') input.up = true;
    if (d==='D') input.down = true;
    if (d==='L') input.left = true;
    if (d==='R') input.right = true;
  }
  function releaseDir(d){
    if (d==='U') input.up = false;
    if (d==='D') input.down = false;
    if (d==='L') input.left = false;
    if (d==='R') input.right = false;
  }

  document.querySelectorAll('.dpad button[data-dir]').forEach(btn=>{
    const d = btn.dataset.dir;

    btn.addEventListener('pointerdown', (e)=>{ e.preventDefault(); pressDir(d); });
    btn.addEventListener('touchstart', (e)=>{ e.preventDefault(); pressDir(d); }, {passive:false});
    btn.addEventListener('mousedown', (e)=>{ e.preventDefault(); pressDir(d); });

    const rel = (e)=>{ e.preventDefault(); releaseDir(d); };
    btn.addEventListener('pointerup', rel);
    btn.addEventListener('pointercancel', rel);
    btn.addEventListener('pointerleave', rel);
    btn.addEventListener('touchend', rel, {passive:false});
    btn.addEventListener('touchcancel', rel, {passive:false});
    btn.addEventListener('mouseup', rel);

    btn.addEventListener('click', (e)=>{ e.preventDefault(); });
  });

  window.addEventListener('blur', clearDirs);
  document.addEventListener('visibilitychange', ()=>{ if (document.hidden) clearDirs(); });

  // A/B/Start/Sel (tracked)
  bindPress('btnA', ()=>{ input.aPressed = true; track('press_a'); });
  bindPress('btnB', ()=>{ input.bPressed = true; track('press_b'); });
  bindPress('btnStart', ()=>{ input.startPressed = true; track('press_start'); });
  bindPress('btnSel', ()=>{ input.selPressed = true; track('press_sel'); });

  // mobile duplicates
  bindPress('mStart', ()=> document.getElementById('btnStart').click());
  bindPress('mSel', ()=> document.getElementById('btnSel').click());

  // Keyboard (tracked)
  window.addEventListener('keydown', (e)=>{
    const k = e.key.toLowerCase();
    if (k==='arrowup') input.up=true;
    else if (k==='arrowdown') input.down=true;
    else if (k==='arrowleft') input.left=true;
    else if (k==='arrowright') input.right=true;
    else if (k==='a' || k===' ') { input.aPressed=true; track('press_a', { src:'kbd' }); }
    else if (k==='b' || k==='backspace') { input.bPressed=true; track('press_b', { src:'kbd' }); }
    else if (k==='enter') { input.startPressed=true; track('press_start', { src:'kbd' }); }
    else if (k==='s') { input.selPressed=true; track('press_sel', { src:'kbd' }); }
  }, {passive:true});

  window.addEventListener('keyup', (e)=>{
    const k = e.key.toLowerCase();
    if (k==='arrowup') input.up=false;
    else if (k==='arrowdown') input.down=false;
    else if (k==='arrowleft') input.left=false;
    else if (k==='arrowright') input.right=false;
  }, {passive:true});

  // Paths + cache bust
  const GAME_PATH = {
    invaders: './games/invaders.js',
    snake: './games/snake.js',
    galattica: './games/galattica.js',
    breakout: './games/breakout.js',
    runner: './games/runner.js',
    tetris: './games/tetris.js'
  };

  let game = null;
  let currentGameId = null;

  function drawMenuScreen(){
    ctx.clearRect(0,0,256,256);
    ctx.fillStyle = 'rgba(0,0,0,.06)';
    ctx.fillRect(0,0,256,256);
    ctx.fillStyle = cssVar('--ink') || '#142016';
    ctx.font = '900 18px ui-monospace, Menlo, Monaco, Consolas, monospace';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('GB-ARCADE', 128, 108);
    ctx.font = '900 12px ui-monospace, Menlo, Monaco, Consolas, monospace';
    ctx.fillText('Choose a cartridge', 128, 140);
  }

  function showMenu(text){
    launcher.classList.remove('hidden');
    gamePill.textContent = 'MENU';
    modePill.textContent = 'READY';
    hudL.textContent = 'SCORE 000';
    hudR.textContent = 'BEST 000';
    msgEl.textContent = text || 'Tocca una cartuccia. SEL = menu.';
    game = null;
    currentGameId = null;
    drawMenuScreen();

    track('menu_open');
  }

  async function loadGame(id){
    const path = GAME_PATH[id];
    if (!path) return;

    currentGameId = id;

    launcher.classList.add('hidden');
    gamePill.textContent = id.toUpperCase();
    modePill.textContent = 'LOADING';
    msgEl.textContent = 'Loading cartridge…';

    // tracking selezione cartuccia
    track('cartridge_select', { game: id });

    try {
      const mod = await import(`${path}?v=${encodeURIComponent(APP_VER)}`);
      if (!mod || typeof mod.createGame !== 'function') {
        throw new Error(`Modulo non valido: manca createGame() in ${path}`);
      }
      game = mod.createGame({ canvas, ctx, hudL, hudR, msgEl });
      game?.reset?.();

      modePill.textContent = 'READY';
      msgEl.textContent = 'START = play/pause • B reset • SEL menu';

      track('cartridge_loaded', { game: id });
    } catch (err) {
      console.error('Cartridge load error:', err);
      modePill.textContent = 'ERROR';
      msgEl.textContent = 'ERRORE: cartuccia non caricata. Controlla /games/ e ricarica.';
      track('cartridge_error', { game: id });

      setTimeout(() => showMenu('Cartuccia non caricata. Verifica i file in /games/.'), 900);
    }
  }

  launcher.addEventListener('click', (e)=>{
    const card = e.target.closest('.cart');
    if (!card) return;
    loadGame(card.dataset.game);
  });

  function globalButtons(){
    if (input.selPressed) {
      track('press_sel_menu', { game: currentGameId || 'menu' });
      showMenu();
    }
    if (input.bPressed){
      track('press_b_back', { game: currentGameId || 'menu' });
      if (game?.back) game.back();
      else showMenu();
    }
  }

  // Main loop fixed 60fps
  let last = performance.now();
  let acc = 0;
  const FIXED = 1000/60;

  function loop(t){
    requestAnimationFrame(loop);
    const dt = Math.min(50, t-last);
    last = t;
    acc += dt;

    while (acc >= FIXED){
      globalButtons();
      game?.update?.(FIXED/1000, input);
      clearPressed();
      acc -= FIXED;
    }
    game?.render?.();
  }

  showMenu();
  requestAnimationFrame(loop);
</script>
</body>
</html>
